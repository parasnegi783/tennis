<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registeration form.1</title>
    <link rel="stylesheet" href="../static/csss/register.css">
    <link rel="icon" type="image/x-icon" href="../static/image/download.png">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>


<body onload="loadDraft()">
    <div class="row">
        <form id="registrationForm" action="{% if loggedUser %}{% url 'update_save_participant' %}{% else %}{% url 'save_participant' %}{% endif %}" method="post" onsubmit="clearDraft()">
            {% csrf_token %}
            <div class="col s12">
                <div class="card-panel">
                    <span class="title">Personal Details</span>
                    
                        <div class="btn-floating btn-small waves-effect waves-light blue" id="smallButton" onclick="saveDraft()">
                            <i class="material-icons" id="buttonIcon">add</i>
                        </div>
                    <div class="row">
                        <div class="input-field col s12 m4">
                            <input id="name" type="text" class="validate" name="name">
                            <label for="name">Full Name</label>
                        </div>
                        <div class="input-field col s12 m4">
                            <input id="date_of_birth" type="text" class="datepicker" name="date_of_birth">
                            <label for="date_of_birth">Date of Birth</label>
                        </div>
                        <div class="input-field col s12 m4">
                            <input id="whatsapp_number" type="number" class="validate" name="whatsapp_number">
                            <label for="whatsapp_number">Whatsapp Number</label>
                        </div>
                    </div>

                    <div class="row">
                        <div class="input-field col s12 m4">
                            <input id="city" type="text" class="validate" name="city" >
                            <label for="city">City</label>
                        </div>
                        <div class="input-field col s12 m4">
                            <input id="email" type="email" class="validate" name="email">
                            <label for="email">Email</label>
                        </div>
                        <div class="input-field col s12 m4">
                            <select id="indian_tree_tshirt_size" name="indian_tree_tshirt_size" >  
                                    <option value="no_need" selected>I don't need</option>
                                    <option value="small">Small</option>
                                    <option value="medium">Medium</option>
                                    <option value="large">Large</option>
                                    <option value="xlarge">XLarge</option>
                                    <option value="xxlarge">XXLarge</option>
                            </select>
                            <label for="indian_tree_tshirt-size">Indian Tree T-Shirt Size</label>
                               
                        </div>
                    </div>

                    <div class="row">
                        <div class="input-field col s12 m4">
                            <select id="indian_tree_shorts_size" name="indian_tree_shorts_size" >
                                <option value="no_need" selected>I don't need</option>
                                <option value="small">Small</option>
                                <option value="medium">Medium</option>
                                <option value="large">Large</option>
                                <option value="xlarge">XLarge</option>
                                <option value="xxlarge">XXLarge</option>
                            </select>
                            <label for="Shorts-size">Indian Tree Shorts Size:</label>
                        </div>
                        <div class="input-field col s12 m4">
                            <select id="food_preference" name="food_preference" >
                                    <option value="not-attending" selected>Not-attending</option>
                                    <option value="non-vegetarian">Non-Vegetarian</option>
                                    <option value="vegetarian">Vegetarian</option>
                            </select>
                            <label for="food-preference">Gala Dinner Food Preference:</label>
                        </div>
                        <div class="input-field col s12 m4">
                            <select id="stay_arrangement" name="stay_arrangement" >
                                    <option value="no" selected>No</option>
                                    <option value="yes">Yes</option>
                            </select>
                            <label for="accommodation">Need place to stay?</label>
                        </div>
                    </div>

                    <div class="row">
                        <div class="input-field col s12 m4">
                            <select id="first_event_category" name="first_event_category" required >
                                    <option value="" disabled selected>Select Category</option>
                                    <option value="Open">Open</option>
                                    <option value="90+">90+</option>
                                    <option value="105+">105+</option>
                                    <option value="120+">120+</option>
                            </select>
                            
                            <label for="first_event_category">Your First-Event Category:</label>
                        </div>
                        <div class="input-field col s12 m4">
                            <select id="first_event" name="first_event"required>
                                <option value="" disabled selected>Select Partner</option>
                                <option value="Not Registered Yet">Not Registered Yet</option>                            
                            </select>                            
                            
                            <label for="First_event">Your First-Event Partner:</label>
                        </div>
                        <div class="input-field col s12 m4">
                            <select id="second_event_category" name="second_event_category" required>
                                <option value="" disabled selected>Select Category</option>
                                <option value="Open">Open</option>
                                <option value="90+">90+</option>
                                <option value="105+">105+</option>
                                <option value="120+">120+</option>
                            </select>
                            <label for="Second-event-category">Second-Event Category:</label>
                        </div>
                       
                        
                    </div>
                    <div class="row last_div">
                        <div class="input-field col s12 m4">
                            <select id="second_event" name="second_event" required>
                                    <option value="" disabled selected>Select Partner</option>
                                    <option value="Not Registered Yet">Not Registered Yet</option>
                            </select>                            
                            
                            <label for="second_event">Your second-Event Partner:</label>
                        </div>
                        
                        <div class="buttonss">

                            <div class="col s12 m4 submit" style="display: flex; justify-content: center;">
                                <div id="backButton" class="btn waves-effect waves-light" href="home">Back</div>
                            </div>
                            <div class="col s12 m4 back" style="display: flex; justify-content: center;">
                                <button class="btn waves-effect waves-light" type="submit" name="action">Submit</button>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
        </form>
    </div>
    <script src="../static/form1.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>


    {% if participant.is_authenticated %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('name').value = '{{ participant.name }}';
        });
    </script>
    {% endif %}

    {% if messages %}
	{% for message in messages %}
	<div class="alert alert-{{ messages.tags }}" role="alert">
		<script>
			setTimeout(function () {
				alert("{{ message }}");
			}, 500);
		</script>
	</div>
	{% endfor %}
	{% endif %}
    
    <script>
        $(document).ready(function() {
            // Initialize Materialize Select component
            $('select').formSelect();
    
            // Function to handle change event on first_event_category select
            $('#first_event_category').change(function() {
                var category = $(this).val();  // Get selected value
                console.log("Selected category:", category);  // Debugging statement
    
                // Perform AJAX request to fetch participants based on selected category
                $.ajax({
                    url: '/fetch_participants/',  // Replace with your backend URL to fetch participants
                    method: 'GET',
                    data: {
                        category: category  // Send selected category as data
                    },
                    beforeSend: function() {
                        console.log("Sending AJAX request...");  // Debugging statement before sending request
                    },
                    success: function(data) {
                        console.log("AJAX request successful. Response:", data);  
    
                        // Clear existing options and re-initialize Materialize Select
                        $('#first_event').empty();  // Clear options
                        $.each(data.participants, function(index, participant) {
                            var optionText = participant.name + ' (' + participant.participant_id + ')';
                            var optionValue = participant.name + '-' + participant.participant_id;
                            console.log("Adding option:", optionText, optionValue);  // Debugging statement for each option
    
                            // Add option using Materialize's Select method
                            $('#first_event').append($('<option>', {
                                value: optionValue,
                                text: optionText
                            }));
                        });
                        $('#first_event').append($('<option>', {
                            value: 'Not Registered Yet',
                            text: 'Not Registered Yet'
                        }));
    
                        // Refresh Materialize Select to reflect changes
                        $('select').formSelect();
                    },
                    error: function(xhr, status, error) {
                        console.error('Error fetching participants:', error);  // Debugging statement for error handling
                    },
                    complete: function() {
                        console.log("AJAX request completed.");  // Debugging statement after request completes (whether success or error)
                    }
                });
            });
        });

        $(document).ready(function() {
            // Initialize Materialize Select component
            $('select').formSelect();
    
            // Function to handle change event on first_event_category select
            $('#second_event_category').change(function() {
                var category = $(this).val();  // Get selected value
                console.log("Selected category:", category);  // Debugging statement
    
                // Perform AJAX request to fetch participants based on selected category
                $.ajax({
                    url: '/load_participant/',  // Replace with your backend URL to fetch participants
                    method: 'GET',
                    data: {
                        category: category  // Send selected category as data
                    },
                    beforeSend: function() {
                        console.log("Sending AJAX request...");  // Debugging statement before sending request
                    },
                    success: function(data) {
                        console.log("AJAX request successful. Response:", data);  
    
                        // Clear existing options and re-initialize Materialize Select
                        $('#second_event').empty();  // Clear options
                        $.each(data.participants, function(index, participant) {
                            var optionText = participant.name + ' (' + participant.participant_id + ')';
                            var optionValue = participant.name + '-' + participant.participant_id;
                            console.log("Adding option:", optionText, optionValue);  // Debugging statement for each option
    
                            // Add option using Materialize's Select method
                            $('#second_event').append($('<option>', {
                                value: optionValue,
                                text: optionText
                            }));
                        });
                        $('#second_event').append($('<option>', {
                            value: 'Not Registered Yet',
                            text: 'Not Registered Yet'
                        }));
    
                        // Refresh Materialize Select to reflect changes
                        $('select').formSelect();
                    },
                    error: function(xhr, status, error) {
                        console.error('Error fetching participants:', error);  // Debugging statement for error handling
                    },
                    complete: function() {
                        console.log("AJAX request completed.");  // Debugging statement after request completes (whether success or error)
                    }
                });
            });
        });
    </script>
    <script>
        document.getElementById("backButton").onclick = function() {
        window.location.href = "home";
    }

    document.addEventListener('DOMContentLoaded', function () {
            var elems = document.querySelectorAll('.datepicker');
            var instances = M.Datepicker.init(elems, {
                format: 'yyyy-mm-dd',
                yearRange: [1900, new Date().getFullYear()], // Set the year range from 1800 to the current year
                defaultDate: new Date(), // Set the default date to today
                setDefaultDate: true, // Display the default date in the datepicker input field
                i18n: {
                    done: 'Select'
                }
            });
        });

    function saveDraft() {
        var draftData = {
            
            name: document.getElementById('name').value,
            email: document.getElementById('email').value,
            date_of_birth: document.getElementById('date_of_birth').value,
            whatsapp_number: document.getElementById('whatsapp_number').value,
            city: document.getElementById('city').value,
            indian_tree_tshirt_size: document.getElementById('indian_tree_tshirt_size').value,
            indian_tree_shorts_size: document.getElementById('indian_tree_shorts_size').value,
            food_preference: document.getElementById('food_preference').value,
            stay_arrangement: document.getElementById('stay_arrangement').value,
            first_event_category: document.getElementById('first_event_category').value,
            first_event: document.getElementById('first_event').value,
            second_event_category: document.getElementById('second_event_category').value,
            second_event: document.getElementById('second_event').value
           
        };
        localStorage.setItem('draftData', JSON.stringify(draftData));
        alert("Your Data is Saved Now...");
    }


    function loadDraft() {
        var draftData = localStorage.getItem('draftData');
        if (draftData) {
            draftData = JSON.parse(draftData);
            document.getElementById('name').value = draftData.name;
            document.getElementById('email').value = draftData.email;
            document.getElementById('date_of_birth').value = draftData.date_of_birth;
            document.getElementById('whatsapp_number').value = draftData.whatsapp_number;
            document.getElementById('city').value = draftData.city;
            
            var tshirtSizeSelect = document.getElementById('indian_tree_tshirt_size');
            if (tshirtSizeSelect) {
                tshirtSizeSelect.value = draftData.indian_tree_tshirt_size;
            }
            
            var shortsSizeSelect = document.getElementById('indian_tree_shorts_size');
            if (shortsSizeSelect) {
                shortsSizeSelect.value = draftData.indian_tree_shorts_size;
            }
            
            var foodPreferenceSelect = document.getElementById('food_preference');
            if (foodPreferenceSelect) {
                foodPreferenceSelect.value = draftData.food_preference;
            }
            
            var stayArrangementSelect = document.getElementById('stay_arrangement');
            if (stayArrangementSelect) {
                stayArrangementSelect.value = draftData.stay_arrangement;
            }
            
            var firstEventCategorySelect = document.getElementById('first_event_category');
            if (firstEventCategorySelect) {
                firstEventCategorySelect.value = draftData.first_event_category;
            }
            
            var firstEventSelect = document.getElementById('first_event');
            if (firstEventSelect) {
                firstEventSelect.value = draftData.first_event;
            }
            
            var secondEventCategorySelect = document.getElementById('second_event_category');
            if (secondEventCategorySelect) {
                secondEventCategorySelect.value = draftData.second_event_category;
            }
            
            var secondEventSelect = document.getElementById('second_event');
            if (secondEventSelect) {
                secondEventSelect.value = draftData.second_event;
            }
            
            M.updateTextFields();
            M.FormSelect.init(document.querySelectorAll('select')); 
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        M.FormSelect.init(document.querySelectorAll('select'));
    });

    M.FormSelect.init(document.querySelectorAll('select'));
    </script>
</body>

</html>



